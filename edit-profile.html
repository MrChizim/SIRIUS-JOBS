<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Edit Profile – Worker</title>
  <meta name="description" content="Update your worker profile on Sirius Jobs." />
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="api.js"></script>
  <script src="session-utils.js"></script>
  <script src="upload-utils.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: { colors: { primary: '#0056b3', secondary: '#0f172a' } }
      }
    }
  </script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    
    body { font-family: 'Inter', sans-serif; }

    @keyframes gradient-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .animated-gradient {
      background-size: 200% 200%;
      animation: gradient-shift 15s ease infinite;
    }
  </style>
  <link rel="stylesheet" href="assets/site-shell.css">
</head>
<body class="bg-white text-gray-800">

  <!-- NAV -->
  <nav data-sirius-shell="skip" class="bg-white/80 backdrop-blur-md border-b border-gray-200/50 sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <a href="index.html" class="inline-flex items-center gap-3">
        <img src="images/logo.png" alt="SiriusJobs logo" class="h-16 w-auto drop-shadow-2xl transition-transform group-hover:scale-105">
        </a>
      <a href="worker-dashboard.html" class="inline-flex items-center gap-2 text-sm font-bold text-gray-700 hover:text-primary transition-colors">
        <i data-feather="arrow-left" class="w-4 h-4"></i>
        Back to Dashboard
      </a>
    </div>
  </nav>

  <!-- HERO -->
  <header class="bg-gradient-to-br from-black via-primary to-blue-900 animated-gradient text-white py-16 px-4">
    <div class="container mx-auto text-center max-w-3xl">
      <div class="inline-flex items-center gap-2 bg-white/10 backdrop-blur-md border border-white/20 rounded-full px-5 py-2.5 mb-6">
        <i data-feather="edit-3" class="w-5 h-5"></i>
        <span class="text-sm font-bold uppercase tracking-wide">Edit Profile</span>
      </div>
      <h1 class="text-4xl md:text-5xl font-black mb-4 leading-tight">Edit Your Profile</h1>
      <p class="text-lg text-white/90 font-medium">Update details to improve your visibility</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-16 max-w-3xl">
    <div class="bg-white rounded-3xl border-2 border-gray-100 shadow-2xl p-8 md:p-12">
      <form id="profileForm" class="space-y-6">
        <div class="grid gap-6 md:grid-cols-2">
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">First Name</label>
            <input id="firstNameInput" type="text" class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-gray-700 font-medium focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all" required>
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Last Name</label>
            <input id="lastNameInput" type="text" class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-gray-700 font-medium focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all" required>
          </div>
        </div>

        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Skill / Profession</label>
          <input id="skillInput" type="text" list="serviceCategoryOptions" class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-gray-700 font-medium focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all" placeholder="Start typing and select from the list" required>
          <datalist id="serviceCategoryOptions"></datalist>
          <p class="text-xs text-gray-500 mt-1">Choose the service that best matches what you offer.</p>
        </div>

        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Years of experience</label>
          <input id="experienceInput" type="number" min="0" max="60" class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-gray-700 font-medium focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all" placeholder="e.g. 5">
        </div>

        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Location (State)</label>
          <select id="locationSelect" class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-gray-700 font-medium focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all" required>
            <option value="">Select State</option>
            <option>Abia – Umuahia</option><option>Adamawa – Yola</option><option>Akwa Ibom – Uyo</option><option>Anambra – Awka</option>
            <option>Bauchi – Bauchi</option><option>Bayelsa – Yenagoa</option><option>Benue – Makurdi</option><option>Borno – Maiduguri</option>
            <option>Cross River – Calabar</option><option>Delta – Asaba</option><option>Ebonyi – Abakaliki</option><option>Edo – Benin City</option>
            <option>Ekiti – Ado-Ekiti</option><option>Enugu – Enugu</option><option>Gombe – Gombe</option><option>Imo – Owerri</option>
            <option>Jigawa – Dutse</option><option>Kaduna – Kaduna</option><option>Kano – Kano</option><option>Katsina – Katsina</option>
            <option>Kebbi – Birnin Kebbi</option><option>Kogi – Lokoja</option><option>Kwara – Ilorin</option><option>Lagos – Ikeja</option>
            <option>Nasarawa – Lafia</option><option>Niger – Minna</option><option>Ogun – Abeokuta</option><option>Ondo – Akure</option>
            <option>Osun – Osogbo</option><option>Oyo – Ibadan</option><option>Plateau – Jos</option><option>Rivers – Port Harcourt</option>
            <option>Sokoto – Sokoto</option><option>Taraba – Jalingo</option><option>Yobe – Damaturu</option><option>Zamfara – Gusau</option>
            <option>Federal Capital Territory – Abuja</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Bio / Description</label>
          <textarea id="bioInput" rows="4" class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-gray-700 font-medium focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all" placeholder="Describe your services, tools and guarantees."></textarea>
        </div>

        <div>
          <label class="block text-sm font-bold text-gray-700 mb-3">Profile Photo</label>
          <div class="flex flex-col sm:flex-row sm:items-start gap-6 p-6 bg-gray-50 rounded-2xl border-2 border-gray-200">
            <img id="profilePhotoPreview" src="/images/users/sample_worker.jpg" alt="Current profile photo" class="w-28 h-28 rounded-2xl object-cover border-2 border-gray-300 shadow-lg" onerror="this.src='https://via.placeholder.com/120x120?text=You'">
            <div class="space-y-3 flex-1">
              <input id="profilePhotoInput" type="file" accept="image/*" class="block w-full text-sm text-gray-700 font-medium border-2 border-gray-200 rounded-xl p-3 cursor-pointer focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
              <p class="text-xs text-gray-500">Upload a clear headshot (PNG or JPG, max 5MB).</p>
              <button type="button" id="removePhotoBtn" class="text-sm font-bold text-primary hover:text-primary/80 transition-colors">Remove current photo</button>
            </div>
          </div>
        </div>

        <p id="profileStatus" class="text-sm font-bold hidden"></p>

        <button id="profileSubmitBtn" type="submit" class="w-full inline-flex items-center justify-center gap-2 bg-primary text-white font-bold py-4 px-6 rounded-xl hover:bg-primary/90 transition-all shadow-lg shadow-primary/25">
          <i data-feather="save" class="w-5 h-5"></i>
          Save Changes
        </button>
      </form>
    </div>
  </main>
  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="site-footer__inner container mx-auto px-4 lg:px-6">
      <div class="site-footer__grid">
        <div class="site-footer__brand">
          <img src="images/logo.png" alt="Sirius logo" class="h-16 w-auto drop-shadow-2xl">
          <p>One platform for trusted professionals, frontline artisans, and the clients who rely on them across Nigeria.</p>
          <div class="site-footer__social">
            <a href="https://web.facebook.com/profile.php?id=61582342397507" target="_blank" rel="noopener"><i data-feather="facebook"></i></a>
            <a href="https://twitter.com/SiriusOddJobs" target="_blank" rel="noopener"><i data-feather="twitter"></i></a>
            <a href="https://www.instagram.com/siriusjobss" target="_blank" rel="noopener"><i data-feather="instagram"></i></a>
            <a href="https://www.linkedin.com/company/siriusjobsng/" target="_blank" rel="noopener"><i data-feather="linkedin"></i></a>
          </div>
        </div>
        <div>
          <h4>Platform</h4>
          <ul class="space-y-2">
            <li><a href="about.html">About</a></li>
            <li><a href="services.html">Services</a></li>
            <li><a href="jobs.html">Jobs</a></li>
            <li><a href="consultations.html">Consultations</a></li>
            <li><a href="marketplace.html">Marketplace</a></li>
          </ul>
        </div>
        <div>
          <h4>Support</h4>
          <ul class="space-y-2">
            <li><a href="contact.html">Contact</a></li>
            <li><a href="faq.html">FAQs</a></li>
            <li><a href="privacypolicy.html">Privacy Policy</a></li>
            <li><a href="terms.html">Terms of Service</a></li>
            <li><a href="verify.html">Verify Credentials</a></li>
          </ul>
        </div>
        <div>
          <h4>Contact</h4>
          <ul class="space-y-2">
            <li><span>WhatsApp: 0704 447 0559</span></li>
            <li><span>Email: info@siriusjobs.com.ng</span></li>
            <li><span>Port Harcourt, Rivers State</span></li>
          </ul>
        </div>
      </div>
      <div class="site-footer__bottom">
        <p>© 2025 Sirius. All rights reserved.</p>
        <div class="flex gap-4"><span>Built for Nigerian businesses & talent.</span></div>
      </div>
    </div>
  </footer>



  <script>
    feather.replace();

    const sessionUtils = window.SiriusSession ?? null;
    const workerSession = sessionUtils?.parse ? sessionUtils.parse('siriusWorkerAuth') : null;
    const profileForm = document.getElementById('profileForm');
    const firstNameInput = document.getElementById('firstNameInput');
    const lastNameInput = document.getElementById('lastNameInput');
    const skillInput = document.getElementById('skillInput');
    const experienceInput = document.getElementById('experienceInput');
    const locationSelect = document.getElementById('locationSelect');
    const bioInput = document.getElementById('bioInput');
    const profileStatus = document.getElementById('profileStatus');
    const submitBtn = document.getElementById('profileSubmitBtn');
    const categoryDatalist = document.getElementById('serviceCategoryOptions');

    const photoPreview = document.getElementById('profilePhotoPreview');
    const photoInput = document.getElementById('profilePhotoInput');
    const removePhotoBtn = document.getElementById('removePhotoBtn');
    const defaultPhoto = photoPreview ? photoPreview.src : '';
    const MAX_PHOTO_BYTES = 5 * 1024 * 1024;
    let photoDataUrl = null;

    const labelToId = new Map();
    const idToLabel = new Map();

    const setStatus = (message, tone = 'info') => {
      if (!profileStatus) return;
      profileStatus.textContent = message;
      profileStatus.className = 'text-sm font-bold';
      if (!message) {
        profileStatus.classList.add('hidden');
        return;
      }
      profileStatus.classList.remove('hidden');
      const toneClass =
        tone === 'success'
          ? 'text-green-600'
          : tone === 'error'
          ? 'text-red-600'
          : 'text-gray-600';
      profileStatus.classList.add(toneClass);
    };

    const loadCategories = async () => {
      const res = await fetch('/api/services/categories');
      if (!res.ok) {
        throw new Error('Unable to load service categories.');
      }
      const categories = await res.json();
      categories.forEach(category => {
        labelToId.set(category.label.toLowerCase(), category.id);
        idToLabel.set(category.id, category.label);
        const option = document.createElement('option');
        option.value = category.label;
        categoryDatalist.appendChild(option);
      });
    };

    const populateForm = profile => {
      const user = profile.user ?? workerSession?.user ?? {};
      firstNameInput.value = user.firstName ?? '';
      lastNameInput.value = user.lastName ?? '';
      const categoryLabel = profile.headline ?? profile.serviceCategory?.label ?? '';
      skillInput.value = categoryLabel;
      if (profile.location) {
        const hasOption = Array.from(locationSelect.options).some(option => option.value === profile.location);
        if (!hasOption) {
          const option = document.createElement('option');
          option.value = profile.location;
          option.textContent = profile.location;
          locationSelect.appendChild(option);
        }
        locationSelect.value = profile.location;
      } else {
        locationSelect.value = '';
      }
      bioInput.value = profile.bio ?? '';
      experienceInput.value = profile.yearsExperience ?? '';
      if (profile.showcaseMediaUrl) {
        photoPreview.src = profile.showcaseMediaUrl;
        photoDataUrl = profile.showcaseMediaUrl;
      } else {
        photoPreview.src = defaultPhoto;
        photoDataUrl = null;
      }
    };

    const loadProfile = async () => {
      setStatus('Loading your profile…');
      const res = await fetch('/api/dashboard/artisan', {
        headers: { Authorization: `Bearer ${workerSession.token}` },
      });
      if (res.status === 401) {
        window.location.href = 'login.html';
        return;
      }
      if (!res.ok) {
        throw new Error('Unable to load your profile right now.');
      }
      const data = await res.json();
      populateForm(data.profile ?? {});
      setStatus('');
    };

    if (photoInput) {
      photoInput.addEventListener('change', async event => {
        const file = event.target.files?.[0];
        if (!file) return;

        // Validate file
        const validation = window.SiriusUpload.validateFile(file, {
          allowedTypes: ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'],
          maxSize: MAX_PHOTO_BYTES
        });

        if (!validation.valid) {
          alert(validation.error);
          photoInput.value = '';
          return;
        }

        // Show preview immediately
        const reader = new FileReader();
        reader.onload = loadEvent => {
          const result = typeof loadEvent.target?.result === 'string' ? loadEvent.target.result : null;
          if (photoPreview && result) {
            photoPreview.src = result;
          }
        };
        reader.readAsDataURL(file);

        // Upload file
        try {
          setStatus('Uploading photo...', 'info');
          const result = await window.SiriusUpload.uploadProfilePhoto(file, workerSession.token);
          photoDataUrl = result.url;
          setStatus('Photo uploaded successfully!', 'success');
          setTimeout(() => setStatus(''), 2000);
        } catch (error) {
          alert('Failed to upload photo: ' + error.message);
          photoInput.value = '';
          photoPreview.src = defaultPhoto;
          photoDataUrl = null;
          setStatus('', '');
        }
      });
    }

    if (removePhotoBtn) {
      removePhotoBtn.addEventListener('click', () => {
        photoDataUrl = null;
        if (photoPreview) {
          photoPreview.src = defaultPhoto;
        }
        if (photoInput) {
          photoInput.value = '';
        }
      });
    }

    profileForm.addEventListener('submit', async event => {
      event.preventDefault();
      if (!workerSession?.token) {
        window.location.href = 'login.html';
        return;
      }

      const firstName = firstNameInput.value.trim();
      const lastName = lastNameInput.value.trim();
      if (firstName.length < 2 || lastName.length < 2) {
        setStatus('Enter your first and last name to continue.', 'error');
        return;
      }

      const skillLabel = skillInput.value.trim();
      const serviceCategoryId = labelToId.get(skillLabel.toLowerCase());
      if (!serviceCategoryId) {
        setStatus('Please select a valid skill from the suggestions.', 'error');
        return;
      }

      const locationValue = locationSelect.value.trim();
      if (!locationValue) {
        setStatus('Select your location.', 'error');
        return;
      }

      const yearsRaw = experienceInput.value ? Number(experienceInput.value) : null;
      if (yearsRaw !== null && (Number.isNaN(yearsRaw) || yearsRaw < 0)) {
        setStatus('Years of experience must be a positive number.', 'error');
        return;
      }

      const payload = {
        firstName,
        lastName,
        serviceCategoryId,
        headline: skillLabel,
        location: locationValue,
        bio: bioInput.value.trim() || null,
        yearsExperience: yearsRaw,
        photo: photoDataUrl,
      };

      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-70', 'cursor-wait');
      setStatus('Saving your profile…');

      try {
        const res = await fetch('/api/profiles/artisan/me', {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${workerSession.token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });
        const body = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(body.message || 'Unable to update your profile right now.');
        }

        if (workerSession) {
          const updatedSession = {
            ...workerSession,
            firstName: body.user?.firstName ?? firstName,
            lastName: body.user?.lastName ?? lastName,
            artisanProfile: {
              ...(workerSession.artisanProfile ?? {}),
              headline: body.profile?.headline ?? skillLabel,
              location: body.profile?.location ?? locationValue,
              bio: body.profile?.bio ?? payload.bio,
              yearsExperience: body.profile?.yearsExperience ?? yearsRaw,
              serviceCategory: body.profile?.serviceCategory ?? workerSession.artisanProfile?.serviceCategory,
              showcaseMediaUrl: body.profile?.showcaseMediaUrl ?? photoDataUrl,
            },
          };
          sessionStorage.setItem('siriusWorkerAuth', JSON.stringify(updatedSession));
        }

        setStatus('Profile updated successfully!', 'success');
        setTimeout(() => {
          window.location.href = 'worker-dashboard.html';
        }, 900);
      } catch (error) {
        setStatus(error.message || 'Unable to update your profile.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-70', 'cursor-wait');
      }
    });

    const init = async () => {
      if (!workerSession?.token) {
        window.location.href = 'login.html';
        return;
      }
      try {
        await loadCategories();
        await loadProfile();
      } catch (error) {
        setStatus(error.message || 'Unable to load the profile form.', 'error');
      }
    };

    init();
  </script>
  <script src="assistant.js"></script>



  <script src="assets/site-shell.js" defer></script>
</body>
</html>

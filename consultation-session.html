<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultation Session – Sirius Jobs</title>
    <meta name="description" content="Your secure consultation session">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0056b3',
                        secondary: '#808080',
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }

        .chat-container {
            height: calc(100vh - 400px);
            min-height: 400px;
        }

        .message-bubble {
            max-width: 70%;
            word-wrap: break-word;
        }

        .scroll-bottom {
            scroll-behavior: smooth;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        .typing-indicator span {
            animation: pulse-dot 1.4s ease-in-out infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased">
    <!-- Header -->
    <header class="fixed w-full top-0 z-50 bg-white border-b border-gray-200">
        <div class="container mx-auto px-4 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Professional Info -->
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-primary to-blue-700 rounded-full flex items-center justify-center">
                        <span id="pro-initials" class="text-white font-black text-lg"></span>
                    </div>
                    <div>
                        <h1 id="pro-name" class="text-lg font-bold text-gray-900"></h1>
                        <p id="pro-profession" class="text-sm text-gray-600"></p>
                    </div>
                </div>

                <!-- Timer & Status -->
                <div class="flex items-center gap-6">
                    <div id="timer" class="hidden md:flex items-center gap-2 bg-blue-50 text-primary px-4 py-2 rounded-full">
                        <i data-feather="clock" class="w-4 h-4"></i>
                        <span id="time-remaining" class="font-semibold text-sm"></span>
                    </div>
                    <button id="end-session-btn" class="hidden md:flex items-center gap-2 bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-full font-semibold text-sm transition-all">
                        <i data-feather="x-circle" class="w-4 h-4"></i>
                        End Session
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-24 pb-6">
        <div class="container mx-auto px-4 lg:px-8 max-w-6xl">
            <!-- Session Info Banner (Mobile) -->
            <div class="md:hidden bg-blue-50 rounded-xl p-4 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2 text-primary">
                        <i data-feather="clock" class="w-4 h-4"></i>
                        <span id="time-remaining-mobile" class="font-semibold text-sm"></span>
                    </div>
                    <button id="end-session-btn-mobile" class="text-red-600 font-semibold text-sm">
                        End Session
                    </button>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <!-- Messages Area -->
                <div id="messages-container" class="chat-container overflow-y-auto p-6 space-y-4 scroll-bottom">
                    <!-- Messages will be inserted here -->
                </div>

                <!-- Typing Indicator -->
                <div id="typing-indicator" class="hidden px-6 py-2 border-t border-gray-100">
                    <div class="flex items-center gap-2 text-gray-500 text-sm">
                        <div class="typing-indicator flex gap-1">
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                        </div>
                        <span>Professional is typing...</span>
                    </div>
                </div>

                <!-- Message Input -->
                <div id="message-input-container" class="border-t border-gray-200 p-4">
                    <form id="message-form" class="flex items-end gap-3">
                        <textarea
                            id="message-input"
                            rows="1"
                            maxlength="2000"
                            placeholder="Type your message..."
                            class="flex-1 resize-none border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                        ></textarea>
                        <button
                            type="submit"
                            class="bg-primary text-white p-3 rounded-xl hover:bg-blue-700 transition-all"
                        >
                            <i data-feather="send" class="w-5 h-5"></i>
                        </button>
                    </form>
                    <p class="text-xs text-gray-500 mt-2">
                        <i data-feather="shield" class="w-3 h-3 inline"></i>
                        Your conversation is anonymous and end-to-end encrypted
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Review Modal -->
    <div id="review-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full p-8">
            <h2 class="text-3xl font-black text-gray-900 mb-4">Rate Your Consultation</h2>
            <p class="text-gray-600 mb-6">Your feedback helps others find great professionals</p>

            <form id="review-form" class="space-y-6">
                <!-- Star Rating -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Rating</label>
                    <div class="flex gap-2">
                        <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="1">★</button>
                        <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="2">★</button>
                        <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="3">★</button>
                        <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="4">★</button>
                        <button type="button" class="star-btn text-4xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="5">★</button>
                    </div>
                    <input type="hidden" id="rating-input" name="rating" required />
                </div>

                <!-- Review Text -->
                <div>
                    <label for="review-text" class="block text-sm font-semibold text-gray-700 mb-2">
                        Your Review
                    </label>
                    <textarea
                        id="review-text"
                        name="reviewText"
                        rows="4"
                        maxlength="500"
                        required
                        class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                        placeholder="Tell others about your experience..."
                    ></textarea>
                    <p class="text-sm text-gray-500 mt-1">
                        <span id="review-char-count">0</span>/500 characters
                    </p>
                </div>

                <!-- Buttons -->
                <div class="flex gap-4">
                    <button
                        type="button"
                        id="skip-review-btn"
                        class="flex-1 bg-gray-200 text-gray-700 font-semibold py-3 rounded-xl hover:bg-gray-300 transition-all"
                    >
                        Skip for Now
                    </button>
                    <button
                        type="submit"
                        class="flex-1 bg-primary text-white font-semibold py-3 rounded-xl hover:bg-blue-700 transition-all"
                    >
                        Submit Review
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:4000/api';
        const SOCKET_URL = 'http://localhost:4000';

        // Get session data
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('sessionId');
        const sessionToken = localStorage.getItem('consultationSessionToken');

        if (!sessionId || !sessionToken) {
            alert('Invalid session access');
            window.location.href = 'consultations.html';
        }

        // Global state
        let socket = null;
        let sessionData = null;
        let professionalData = null;
        let timerInterval = null;
        let selectedRating = 0;

        // Initialize
        async function initialize() {
            try {
                // Fetch session details
                const response = await fetch(`${API_URL}/consultation/sessions/${sessionId}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load session');

                const result = await response.json();
                sessionData = result.data.session;
                professionalData = result.data.professional;

                // Update UI
                renderProfessionalInfo();
                checkSessionStatus();

                // Load messages
                await loadMessages();

                // Connect to Socket.io
                connectSocket();

                // Start timer
                startTimer();

                feather.replace();
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to load session');
                window.location.href = 'consultations.html';
            }
        }

        // Render professional info
        function renderProfessionalInfo() {
            const initials = `${professionalData.firstName[0]}${professionalData.lastName[0]}`;
            document.getElementById('pro-initials').textContent = initials;
            document.getElementById('pro-name').textContent = `${professionalData.firstName} ${professionalData.lastName}`;
            document.getElementById('pro-profession').textContent = `${professionalData.profession} • ${professionalData.specialization}`;
        }

        // Check session status
        function checkSessionStatus() {
            if (sessionData.status === 'ended' || sessionData.status === 'expired') {
                document.getElementById('message-input-container').innerHTML = `
                    <div class="text-center py-6 text-gray-600">
                        <i data-feather="check-circle" class="w-12 h-12 mx-auto mb-2"></i>
                        <p class="font-semibold">Session has ended</p>
                    </div>
                `;
                document.getElementById('end-session-btn').classList.add('hidden');
                document.getElementById('end-session-btn-mobile').classList.add('hidden');
                showReviewModal();
                feather.replace();
            }
        }

        // Connect to Socket.io
        function connectSocket() {
            socket = io(SOCKET_URL, {
                auth: {
                    sessionToken: sessionToken
                }
            });

            socket.on('connect', () => {
                console.log('Connected to Socket.io');
            });

            socket.on('consultation:message', (message) => {
                appendMessage(message);
            });

            socket.on('consultation:error', (error) => {
                console.error('Socket error:', error);
                alert(error.message);
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from Socket.io');
            });
        }

        // Load messages
        async function loadMessages() {
            try {
                const response = await fetch(`${API_URL}/consultation/sessions/${sessionId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load messages');

                const result = await response.json();
                const container = document.getElementById('messages-container');
                container.innerHTML = '';

                result.data.messages.forEach(msg => appendMessage(msg, false));
                scrollToBottom();
            } catch (error) {
                console.error('Load messages error:', error);
            }
        }

        // Append message to chat
        function appendMessage(message, scroll = true) {
            const container = document.getElementById('messages-container');
            const isOwn = message.senderType === 'client';
            const isSystem = message.messageType === 'system';

            const messageDiv = document.createElement('div');

            if (isSystem) {
                messageDiv.className = 'text-center';
                messageDiv.innerHTML = `
                    <div class="inline-block bg-gray-100 text-gray-600 text-sm px-4 py-2 rounded-full">
                        ${message.content}
                    </div>
                `;
            } else {
                messageDiv.className = `flex ${isOwn ? 'justify-end' : 'justify-start'}`;
                messageDiv.innerHTML = `
                    <div class="message-bubble ${isOwn ? 'bg-primary text-white' : 'bg-gray-200 text-gray-900'} px-4 py-3 rounded-2xl ${isOwn ? 'rounded-tr-sm' : 'rounded-tl-sm'}">
                        <p class="whitespace-pre-wrap">${escapeHtml(message.content)}</p>
                        <p class="text-xs mt-1 ${isOwn ? 'text-blue-100' : 'text-gray-500'}">
                            ${formatTime(message.createdAt)}
                        </p>
                    </div>
                `;
            }

            container.appendChild(messageDiv);
            if (scroll) scrollToBottom();
        }

        // Send message
        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const input = document.getElementById('message-input');
            const content = input.value.trim();

            if (!content) return;

            // Send via Socket.io
            socket.emit('consultation:message', {
                sessionId: sessionId,
                content: content
            });

            input.value = '';
            input.style.height = 'auto';
        });

        // Auto-resize textarea
        document.getElementById('message-input').addEventListener('input', (e) => {
            e.target.style.height = 'auto';
            e.target.style.height = Math.min(e.target.scrollHeight, 150) + 'px';
        });

        // End session
        async function endSession() {
            if (!confirm('Are you sure you want to end this consultation?')) return;

            try {
                const response = await fetch(`${API_URL}/consultation/sessions/${sessionId}/end`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to end session');

                sessionData.status = 'ended';
                checkSessionStatus();
            } catch (error) {
                console.error('End session error:', error);
                alert('Failed to end session');
            }
        }

        document.getElementById('end-session-btn').addEventListener('click', endSession);
        document.getElementById('end-session-btn-mobile').addEventListener('click', endSession);

        // Timer
        function startTimer() {
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            if (!sessionData.endsAt) return;

            const now = new Date();
            const endsAt = new Date(sessionData.endsAt);
            const diff = endsAt - now;

            if (diff <= 0) {
                document.getElementById('time-remaining').textContent = 'Expired';
                document.getElementById('time-remaining-mobile').textContent = 'Expired';
                clearInterval(timerInterval);
                sessionData.status = 'expired';
                checkSessionStatus();
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            const timeString = `${hours}h ${minutes}m ${seconds}s`;
            document.getElementById('time-remaining').textContent = timeString;
            document.getElementById('time-remaining-mobile').textContent = timeString;
        }

        // Review modal
        function showReviewModal() {
            document.getElementById('review-modal').classList.remove('hidden');
        }

        function hideReviewModal() {
            document.getElementById('review-modal').classList.add('hidden');
            window.location.href = 'consultations.html';
        }

        // Star rating
        const starButtons = document.querySelectorAll('.star-btn');
        starButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                selectedRating = parseInt(btn.dataset.rating);
                document.getElementById('rating-input').value = selectedRating;

                starButtons.forEach((star, index) => {
                    if (index < selectedRating) {
                        star.classList.remove('text-gray-300');
                        star.classList.add('text-yellow-400');
                    } else {
                        star.classList.remove('text-yellow-400');
                        star.classList.add('text-gray-300');
                    }
                });
            });
        });

        // Review character count
        document.getElementById('review-text').addEventListener('input', (e) => {
            document.getElementById('review-char-count').textContent = e.target.value.length;
        });

        // Submit review
        document.getElementById('review-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const rating = selectedRating;
            const reviewText = document.getElementById('review-text').value.trim();

            if (!rating) {
                alert('Please select a rating');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/consultation/sessions/${sessionId}/review`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({ rating, reviewText })
                });

                if (!response.ok) throw new Error('Failed to submit review');

                alert('Thank you for your review!');
                hideReviewModal();
            } catch (error) {
                console.error('Review submission error:', error);
                alert('Failed to submit review');
            }
        });

        document.getElementById('skip-review-btn').addEventListener('click', hideReviewModal);

        // Utility functions
        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize on load
        feather.replace();
        initialize();
    </script>
    <script src="assistant.js"></script>
</body>
</html>

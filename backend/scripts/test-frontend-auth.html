<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Frontend Auth Test</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    h1 { color: #4ec9b0; }
    h2 { color: #569cd6; margin-top: 30px; }
    .test {
      background: #252526;
      padding: 15px;
      margin: 10px 0;
      border-left: 3px solid #007acc;
      border-radius: 3px;
    }
    .success { border-left-color: #4ec9b0; }
    .error { border-left-color: #f48771; }
    .status { font-weight: bold; }
    .success .status { color: #4ec9b0; }
    .error .status { color: #f48771; }
    pre {
      background: #1e1e1e;
      padding: 10px;
      overflow-x: auto;
      border-radius: 3px;
    }
    button {
      background: #007acc;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border-radius: 3px;
      font-size: 14px;
    }
    button:hover { background: #005a9e; }
    #results { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>ðŸ§ª Frontend Authentication Test Suite</h1>

  <div>
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="clearResults()">Clear Results</button>
  </div>

  <div id="results"></div>

  <script src="../api.js"></script>
  <script src="../session-utils.js"></script>
  <script src="../marketplace-auth.js"></script>

  <script>
    const resultsDiv = document.getElementById('results');

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `test ${type}`;
      div.innerHTML = `
        <span class="status">${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â†’'}</span>
        ${message}
      `;
      resultsDiv.appendChild(div);
    }

    function clearResults() {
      resultsDiv.innerHTML = '';
      sessionStorage.clear();
      localStorage.clear();
    }

    async function testApiBase() {
      log('<h2>Test 1: API Base Configuration</h2>');
      try {
        if (typeof window.__SIRIUS_API_BASE !== 'undefined') {
          log(`API Base URL: ${window.__SIRIUS_API_BASE}`, 'success');
        } else {
          log('API Base URL not configured', 'error');
        }

        if (typeof window.__buildApiUrl === 'function') {
          const testUrl = window.__buildApiUrl('/api/test');
          log(`URL Builder working: /api/test â†’ ${testUrl}`, 'success');
        }
      } catch (error) {
        log(`API Base Error: ${error.message}`, 'error');
      }
    }

    async function testSessionUtils() {
      log('<h2>Test 2: Session Utils</h2>');
      try {
        if (typeof window.SiriusSession !== 'undefined') {
          log('SiriusSession loaded successfully', 'success');

          // Test payload creation
          const mockData = {
            token: 'test-token-123',
            user: {
              id: 'user-123',
              email: 'test@example.com',
              firstName: 'Test',
              lastName: 'User',
              role: 'ARTISAN',
              roles: ['ARTISAN', 'EMPLOYER']
            }
          };

          const payload = window.SiriusSession.createPayload(mockData, { activeRole: 'ARTISAN' });
          log(`Created session payload with ${payload.roles.length} roles`, 'success');
          log(`<pre>${JSON.stringify(payload, null, 2)}</pre>`);

          // Test persistence
          window.SiriusSession.persist(payload);
          const stored = window.SiriusSession.parse('siriusWorkerAuth');
          if (stored && stored.activeRole === 'ARTISAN') {
            log('Session persistence working correctly', 'success');
          } else {
            log('Session persistence failed', 'error');
          }
        } else {
          log('SiriusSession not loaded', 'error');
        }
      } catch (error) {
        log(`Session Utils Error: ${error.message}`, 'error');
      }
    }

    async function testMarketplaceAuth() {
      log('<h2>Test 3: Marketplace Authentication</h2>');
      try {
        if (typeof window.SiriusMarketplaceAuth !== 'undefined') {
          log('SiriusMarketplaceAuth loaded successfully', 'success');

          // Test registration
          try {
            const merchant = window.SiriusMarketplaceAuth.register({
              businessName: 'Test Shop',
              contactName: 'Test Merchant',
              email: 'merchant@test.com',
              phone: '+2348012345678',
              password: 'TestPass123',
              plan: '3-month'
            });
            log(`Merchant registered: ${merchant.businessName} (${merchant.email})`, 'success');
          } catch (error) {
            if (error.message.includes('already exists')) {
              log('Merchant already registered (expected)', 'success');
            } else {
              throw error;
            }
          }

          // Test login
          const loggedIn = window.SiriusMarketplaceAuth.login('merchant@test.com', 'TestPass123');
          log(`Merchant logged in: ${loggedIn.businessName}`, 'success');

          // Test get active merchant
          const active = window.SiriusMarketplaceAuth.getActiveMerchant();
          if (active && active.email === 'merchant@test.com') {
            log('Active merchant retrieval working', 'success');
          } else {
            log('Active merchant retrieval failed', 'error');
          }

          // Test logout
          window.SiriusMarketplaceAuth.logout();
          const afterLogout = window.SiriusMarketplaceAuth.getActiveMerchant();
          if (!afterLogout) {
            log('Logout working correctly', 'success');
          } else {
            log('Logout failed', 'error');
          }
        } else {
          log('SiriusMarketplaceAuth not loaded', 'error');
        }
      } catch (error) {
        log(`Marketplace Auth Error: ${error.message}`, 'error');
      }
    }

    async function testBackendIntegration() {
      log('<h2>Test 4: Backend Integration</h2>');
      try {
        // Test health endpoint
        const healthResponse = await fetch('/api/health');
        const healthData = await healthResponse.json();
        if (healthData.status === 'ok') {
          log('Backend health check: OK', 'success');
        } else {
          log('Backend health check: FAILED', 'error');
        }

        // Test login endpoint with test account
        const loginResponse = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'worker@test.com',
            password: 'Test1234'
          })
        });

        if (loginResponse.ok) {
          const loginData = await loginResponse.json();
          log('Login endpoint working correctly', 'success');

          // Test session creation with real data
          const sessionPayload = window.SiriusSession.createPayload(loginData, {
            activeRole: 'ARTISAN',
            email: 'worker@test.com'
          });
          window.SiriusSession.persist(sessionPayload);
          log('Session created and persisted from backend response', 'success');

          // Verify token
          if (loginData.token && loginData.token.length > 50) {
            log(`JWT token received (${loginData.token.length} chars)`, 'success');
          }
        } else {
          log('Login endpoint returned error', 'error');
        }

      } catch (error) {
        log(`Backend Integration Error: ${error.message}`, 'error');
      }
    }

    async function runAllTests() {
      clearResults();
      log('<h1>ðŸš€ Starting Frontend Authentication Tests</h1>');
      await testApiBase();
      await testSessionUtils();
      await testMarketplaceAuth();
      await testBackendIntegration();
      log('<h2>âœ… All Tests Complete</h2>', 'success');
    }

    // Auto-run on load
    window.addEventListener('load', () => {
      setTimeout(runAllTests, 500);
    });
  </script>
</body>
</html>
